<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HSBC Confluence Chatbot</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" />
<link rel="icon" type="image/png" href="https://cdn.icon-icons.com/icons2/2699/PNG/64/hsbc_logo_icon_170012.png" />

<style>
/* (STYLE BLOCK SAME AS YOUR ORIGINAL â€” UNCHANGED) */
    body {
        margin: 0;
        background: #f7f7f7;
        font-family: 'Inter', sans-serif;
        height: 100vh;
        overflow: hidden;
        display: flex;
    }

    .layout {
        display: flex;
        width: 100%;
        height: 100vh;
    }

    .sidebar {
        width: 260px;
        background: #ffffff;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        overflow: hidden;
    }

    .sidebar.collapsed {
        width: 60px !important;
    }

    .sidebar-header {
        height: 76px;
        background: #b71c1c;
        color: #ffffff;
        display: flex;
        align-items: center;
        padding: 0 16px;
        justify-content: space-between;
        border-bottom: 1px solid #9f1a1a;
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
    }

    .sidebar.collapsed .sidebar-title,
    .sidebar.collapsed .chat-list {
        display: none;
    }

    .new-chat-btn {
        margin: 15px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #b71c1c;
        background: #ffffff;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
        color: #b71c1c;
        transition: 0.3s ease, transform 0.2s ease;
    }

    .new-chat-btn:hover {
        background: #f4d4d4;
        transform: scale(1.05);
    }

    .new-chat-btn.collapsed-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        font-size: 18px;
        justify-content: center;
        align-items: center;
        display: flex;
    }

    .new-chat-btn.collapsed-btn i {
        margin: 0;
        line-height: 40px;
    }

    .sidebar.collapsed .new-chat-btn {
        margin-left: auto;
        margin-right: auto;
    }

    .hamburger {
        font-size: 22px;
        cursor: pointer;
        color: white;
        padding: 8px 10px;
        border-radius: 6px;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 12px 20px;
    }

    .chat-item {
        padding: 14px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 8px;
        transition: 0.2s;
        font-size: 14px;
    }

    .chat-item:hover {
        background: #f5f5f5;
    }

    .chat-item.active {
        background: #fbeaea;
        border: 1px solid #b71c1c;
        color: #8e0000;
        font-weight: 500;
    }

    .chat-area {
        flex-grow: 1;
        height: 100vh;
        background: #fbeaea;
        transition: width 0.3s ease;
        width: calc(100% - 260px);
        display: flex;
        flex-direction: column;
    }

    .chat-area.expanded {
        width: calc(100% - 60px) !important;
    }

    .chat-header {
        height: 76px;
        background: #b71c1c;
        color: #ffffff;
        display: flex;
        align-items: center;
        padding: 0 22px;
        gap: 15px;
        font-size: 18px;
        font-weight: 600;
    }

    .chat-logo {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        object-fit: contain;
    }

    .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 28px 22px;
        background: #fff5f5;
    }

    .msg-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 26px;
        gap: 12px;
    }

    .msg {
        max-width: 750px;
        padding: 14px 18px;
        border-radius: 10px;
        font-size: 15px;
        background: #fff5f5;
        border: 1px solid #b71c1c;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
    }

    .msg-user {
        margin-left: auto;
        color: #600000;
    }

    .msg-bot {
        color: #000000;
    }

    .suggested-box {
        padding: 12px 20px;
        background: #fbeaea;
        border-top: none;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
    }

    .suggested-chip {
        padding: 10px 20px;
        background: #fbeaea;
        border-radius: 30px;
        font-size: 14px;
        cursor: pointer;
        white-space: nowrap;
        border: 1px solid #b71c1c;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        transition: 0.2s ease;
    }

    .suggested-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.18);
    }

    .chat-footer {
        padding: 16px 22px;
        background: #fbeaea;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-input-wrapper {
        width: 100%;
        background: #fff5f5;
        border-radius: 30px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        border: 1px solid #b71c1c;
        box-shadow: 0 2px 6px rgba(0,0,0,0.10);
    }

    .chat-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 15px;
        outline: none;
    }

    .send-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: #000;
        padding-left: 10px;
        transition: 0.25s ease;
    }

    .send-btn:hover {
        color: #b71c1c;
        transform: translateY(-2px) scale(1.15);
    }

    .thinking-dot {
        display: inline-block;
        animation: blink 1.4s infinite both;
        font-weight: bold;
    }

    .thinking-dot:nth-child(1) { animation-delay: 0s; }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }
</style>
</head>

<body>
<div class="layout">

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Chats</span>
            <i class="fas fa-bars hamburger" id="toggleSidebar"></i>
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            <span class="btn-text">New Chat</span>
        </button>

        <div id="chatList" class="chat-list"></div>
    </div>

    <div class="chat-area" id="chatArea">

        <div class="chat-header">
            <img src="https://seekvectors.com/files/download/hsbc-logo-01.jpg" class="chat-logo" />
            <div class="chat-title">HSBC Confluence Chatbot</div>
        </div>

        <div id="message-area" class="chat-body"></div>

        <div class="suggested-box">
            <div class="suggested-chip">What all attributes are present in the Sample Data Asset</div>
            <div class="suggested-chip">What is AI</div>
            <div class="suggested-chip">Explain about Reinforcement Learning</div>
            <div class="suggested-chip">Explain the schema of Sample Data Asset</div>
        </div>

        <div class="chat-footer">
            <div class="chat-input-wrapper">
                <input type="text" id="text" class="chat-input" placeholder="Ask anything..." />
                <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

    </div>
</div>

<script>

    const input = document.getElementById('text');
    const sendBtn = document.getElementById('sendBtn');
    const chat = document.getElementById('message-area');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatList = document.getElementById('chatList');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const chatArea = document.getElementById('chatArea');

    let chats = [];
    let currentChatIndex = -1;

    // *** FIX FLAG ***
    let isLoadingChat = false;

    function createNewChat() {
        chats.push([]);
        currentChatIndex = chats.length - 1;
        renderChatList();
        loadChat();
    }

    function renderChatList() {
        chatList.innerHTML = '';
        chats.forEach((c, i) => {
            const item = document.createElement('div');
            item.className = 'chat-item' + (i === currentChatIndex ? ' active' : '');
            item.textContent = 'Chat ' + (i + 1);
            item.onclick = () => {
                currentChatIndex = i;
                renderChatList();
                loadChat();
            };
            chatList.appendChild(item);
        });
    }

    function sanitizeMessage(text) {
        return text.replace(/<span class="thinking-dot">.*?<\/span>/g, '');
    }

    function addMessage(text, type) {
        const row = document.createElement('div');
        row.className = 'msg-row';

        const icon = document.createElement('div');
        icon.className = 'msg-icon';
        icon.innerHTML =
            type === 'user'
                ? '<i class="fas fa-user"></i>'
                : '<i class="fas fa-robot"></i>';

        const msg = document.createElement('div');
        msg.className = type === 'user' ? 'msg msg-user' : 'msg msg-bot';
        msg.innerHTML = text;

        if (type === 'user') {
            row.appendChild(msg);
            row.appendChild(icon);
        } else {
            row.appendChild(icon);
            row.appendChild(msg);
        }

        chat.appendChild(row);
        chat.scrollTop = chat.scrollHeight;

        // *** FIX: Do not save messages if loading chat ***
        if (!isLoadingChat && type !== 'thinking') {
            chats[currentChatIndex].push({ text: sanitizeMessage(text), type });
        }

        return msg;
    }

    function loadChat() {
        isLoadingChat = true; // prevent saving duplicates

        chat.innerHTML = '';

        chats[currentChatIndex].forEach((m) =>
            addMessage(sanitizeMessage(m.text), m.type)
        );

        isLoadingChat = false;
    }

    function addThinking() {
        const thinkingDots =
            '<span class="thinking-dot">.</span>' +
            '<span class="thinking-dot">.</span>' +
            '<span class="thinking-dot">.</span>';
        return addMessage(thinkingDots, 'thinking');
    }

    async function sendMessage() {
        const text = input.value.trim();
        if (!text || currentChatIndex === -1) return;

        addMessage(text, 'user');
        input.value = '';

        const thinkingMsg = addThinking();

        try {
            const formData = new FormData();
            formData.append("msg", text);

            const response = await fetch("/get", {
                method: "POST",
                body: formData
            });

            const botReply = await response.text();

            const cleanReply = sanitizeMessage(botReply);
            thinkingMsg.innerHTML = cleanReply;

            chats[currentChatIndex].push({ text: cleanReply, type: 'bot' });

        } catch (err) {
            thinkingMsg.innerHTML = "Error: Could not reach server.";
            chats[currentChatIndex].push({
                text: "Error: Could not reach server.",
                type: 'bot'
            });
        }
    }

    sendBtn.onclick = sendMessage;

    input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    document.querySelectorAll(".suggested-chip").forEach(chip => {
        chip.addEventListener("click", () => {
            input.value = chip.textContent;
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
        });
    });

    toggleSidebar.onclick = () => {
        sidebar.classList.toggle("collapsed");
        chatArea.classList.toggle("expanded");

        if (sidebar.classList.contains("collapsed")) {
            newChatBtn.classList.add("collapsed-btn");
            newChatBtn.innerHTML = '<i class="fas fa-comments"></i>';
        } else {
            newChatBtn.classList.remove("collapsed-btn");
            newChatBtn.innerHTML = '<i class="fas fa-plus"></i> <span class="btn-text">New Chat</span>';
        }
    };

    newChatBtn.onclick = createNewChat;

    createNewChat();

</script>

</body>
</html>
